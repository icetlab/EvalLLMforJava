diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
index c586b38f12..fcaec20c38 100644
--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
@@ -215,35 +215,47 @@ public final class MapToMapCast
     {
         checkState(toMapType.getTypeParameters().size() == 2, "Expect two type parameters for toMapType");
         Type toKeyType = toMapType.getTypeParameters().get(0);
-        TypedSet typedSet = new TypedSet(toKeyType, fromMap.getPositionCount() / 2, "map-to-map cast");
-        BlockBuilder keyBlockBuilder = toKeyType.createBlockBuilder(null, fromMap.getPositionCount() / 2);
-        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {
+        Type toValueType = toMapType.getTypeParameters().get(1);
+        int positionCount = fromMap.getPositionCount();
+        int mapSize = positionCount / 2;
+
+        // Step 1: Process all keys and values.
+        // This is faster than processing all keys and then all values
+        // as the original block can be kept in cache.
+        BlockBuilder keyBlockBuilder = toKeyType.createBlockBuilder(null, mapSize);
+        BlockBuilder valueBlockBuilder = toValueType.createBlockBuilder(null, mapSize);
+        for (int i = 0; i < positionCount; i += 2) {
             try {
                 keyProcessFunction.invokeExact(fromMap, i, properties, keyBlockBuilder);
             }
             catch (Throwable t) {
                 throw internalError(t);
             }
-        }
-        Block keyBlock = keyBlockBuilder.build();
 
-        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);
-        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();
-        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {
-            if (typedSet.add(keyBlock, i / 2)) {
-                toKeyType.appendTo(keyBlock, i / 2, blockBuilder);
             if (fromMap.isNull(i + 1)) {
-                    blockBuilder.appendNull();
-                    continue;
+                valueBlockBuilder.appendNull();
             }
-
+            else {
                 try {
-                    valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);
+                    valueProcessFunction.invokeExact(fromMap, i + 1, properties, valueBlockBuilder);
                 }
                 catch (Throwable t) {
                     throw internalError(t);
                 }
             }
+        }
+        Block keyBlock = keyBlockBuilder.build();
+        Block valueBlock = valueBlockBuilder.build();
+
+        // Step 2: Check for duplicate keys and build the map.
+        TypedSet typedSet = new TypedSet(toKeyType, mapSize, "map-to-map cast");
+        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);
+        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();
+        for (int i = 0; i < mapSize; i++) {
+            if (typedSet.add(keyBlock, i)) {
+                toKeyType.appendTo(keyBlock, i, blockBuilder);
+                toValueType.appendTo(valueBlock, i, blockBuilder);
+            }
             else {
                 // if there are duplicated keys, fail it!
                 throw new PrestoException(INVALID_CAST_ARGUMENT, "duplicate keys");
