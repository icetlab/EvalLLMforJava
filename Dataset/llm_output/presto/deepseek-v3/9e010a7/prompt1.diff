diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
index c586b38f12..98258e64e1 100644
--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
@@ -121,7 +121,12 @@ public final class MapToMapCast
         }
 
         MethodHandle writer = nativeValueWriter(toType);
-        writer = permuteArguments(writer, methodType(void.class, writer.type().parameterArray()[1], writer.type().parameterArray()[0]), 1, 0);
+        // Optimize: avoid permuteArguments when possible by checking parameter order
+        if (writer.type().parameterArray()[0] == BlockBuilder.class) {
+            // Already in correct order: (BlockBuilder, value)
+            writer = permuteArguments(writer, methodType(void.class, writer.type().parameterArray()[1], writer.type().parameterArray()[0]), 1, 0);
+        }
+        // else: parameter order is already (value, BlockBuilder)
 
         return compose(writer, target.asType(methodType(unwrap(target.type().returnType()), target.type().parameterArray())));
     }
@@ -140,23 +145,20 @@ public final class MapToMapCast
      */
     private MethodHandle nullChecker(Class<?> javaType)
     {
-        if (javaType == Long.class) {
-            return CHECK_LONG_IS_NOT_NULL;
-        }
-        else if (javaType == Double.class) {
-            return CHECK_DOUBLE_IS_NOT_NULL;
-        }
-        else if (javaType == Boolean.class) {
-            return CHECK_BOOLEAN_IS_NOT_NULL;
-        }
-        else if (javaType == Slice.class) {
-            return CHECK_SLICE_IS_NOT_NULL;
-        }
-        else if (javaType == Block.class) {
-            return CHECK_BLOCK_IS_NOT_NULL;
-        }
-        else {
-            throw new IllegalArgumentException("Unknown java type " + javaType);
+        // Use a switch statement for better performance with frequent calls
+        switch (javaType.getName()) {
+            case "java.lang.Long":
+                return CHECK_LONG_IS_NOT_NULL;
+            case "java.lang.Double":
+                return CHECK_DOUBLE_IS_NOT_NULL;
+            case "java.lang.Boolean":
+                return CHECK_BOOLEAN_IS_NOT_NULL;
+            case "io.airlift.slice.Slice":
+                return CHECK_SLICE_IS_NOT_NULL;
+            case "com.facebook.presto.common.block.Block":
+                return CHECK_BLOCK_IS_NOT_NULL;
+            default:
+                throw new IllegalArgumentException("Unknown java type " + javaType);
         }
     }
 
@@ -216,32 +218,40 @@ public final class MapToMapCast
         checkState(toMapType.getTypeParameters().size() == 2, "Expect two type parameters for toMapType");
         Type toKeyType = toMapType.getTypeParameters().get(0);
         TypedSet typedSet = new TypedSet(toKeyType, fromMap.getPositionCount() / 2, "map-to-map cast");
-        BlockBuilder keyBlockBuilder = toKeyType.createBlockBuilder(null, fromMap.getPositionCount() / 2);
+        
+        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);
+        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();
+        
+        // Temporary block builder for key processing
+        BlockBuilder keyBlockBuilder = toKeyType.createBlockBuilder(null, 1);
+        
         for (int i = 0; i < fromMap.getPositionCount(); i += 2) {
+            // Process key and check for duplicates in a single pass
+            keyBlockBuilder = keyBlockBuilder.newBlockBuilderLike(null);
             try {
                 keyProcessFunction.invokeExact(fromMap, i, properties, keyBlockBuilder);
             }
             catch (Throwable t) {
                 throw internalError(t);
             }
-        }
-        Block keyBlock = keyBlockBuilder.build();
-
-        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);
-        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();
-        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {
-            if (typedSet.add(keyBlock, i / 2)) {
-                toKeyType.appendTo(keyBlock, i / 2, blockBuilder);
+            
+            Block singleKeyBlock = keyBlockBuilder.build();
+            
+            if (typedSet.add(singleKeyBlock, 0)) {
+                // Append the processed key
+                toKeyType.appendTo(singleKeyBlock, 0, blockBuilder);
+                
+                // Process value
                 if (fromMap.isNull(i + 1)) {
                     blockBuilder.appendNull();
-                    continue;
-                }
-
-                try {
-                    valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);
                 }
-                catch (Throwable t) {
-                    throw internalError(t);
+                else {
+                    try {
+                        valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);
+                    }
+                    catch (Throwable t) {
+                        throw internalError(t);
+                    }
                 }
             }
             else {
