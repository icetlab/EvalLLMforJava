diff --git a/buffer/src/main/java/io/netty/buffer/AbstractByteBuf.java b/buffer/src/main/java/io/netty/buffer/AbstractByteBuf.java
index c8c40a5d24..b711b2aebf 100644
--- a/buffer/src/main/java/io/netty/buffer/AbstractByteBuf.java
+++ b/buffer/src/main/java/io/netty/buffer/AbstractByteBuf.java
@@ -257,14 +257,10 @@ public abstract class AbstractByteBuf extends ByteBuf {
         if (markedReaderIndex <= decrement) {
             this.markedReaderIndex = 0;
             int markedWriterIndex = this.markedWriterIndex;
-            if (markedWriterIndex <= decrement) {
-                this.markedWriterIndex = 0;
-            } else {
-                this.markedWriterIndex = markedWriterIndex - decrement;
-            }
+            this.markedWriterIndex = markedWriterIndex <= decrement ? 0 : markedWriterIndex - decrement;
         } else {
             this.markedReaderIndex = markedReaderIndex - decrement;
-            markedWriterIndex -= decrement;
+            this.markedWriterIndex -= decrement;
         }
     }
 
@@ -663,24 +659,21 @@ public abstract class AbstractByteBuf extends ByteBuf {
 
         int nLong = length >>> 3;
         int nBytes = length & 7;
-        for (int i = nLong; i > 0; i --) {
+        for (int i = 0; i < nLong; i++) {
             _setLong(index, 0);
             index += 8;
         }
         if (nBytes == 4) {
             _setInt(index, 0);
-            // Not need to update the index as we not will use it after this.
         } else if (nBytes < 4) {
-            for (int i = nBytes; i > 0; i --) {
-                _setByte(index, (byte) 0);
-                index ++;
+            for (int i = 0; i < nBytes; i++) {
+                _setByte(index + i, (byte) 0);
             }
         } else {
             _setInt(index, 0);
             index += 4;
-            for (int i = nBytes - 4; i > 0; i --) {
-                _setByte(index, (byte) 0);
-                index ++;
+            for (int i = 0; i < nBytes - 4; i++) {
+                _setByte(index + i, (byte) 0);
             }
         }
         return this;
@@ -1154,7 +1147,7 @@ public abstract class AbstractByteBuf extends ByteBuf {
 
         int nLong = length >>> 3;
         int nBytes = length & 7;
-        for (int i = nLong; i > 0; i --) {
+        for (int i = 0; i < nLong; i++) {
             _setLong(wIndex, 0);
             wIndex += 8;
         }
@@ -1162,17 +1155,17 @@ public abstract class AbstractByteBuf extends ByteBuf {
             _setInt(wIndex, 0);
             wIndex += 4;
         } else if (nBytes < 4) {
-            for (int i = nBytes; i > 0; i --) {
-                _setByte(wIndex, (byte) 0);
-                wIndex++;
+            for (int i = 0; i < nBytes; i++) {
+                _setByte(wIndex + i, (byte) 0);
             }
+            wIndex += nBytes;
         } else {
             _setInt(wIndex, 0);
             wIndex += 4;
-            for (int i = nBytes - 4; i > 0; i --) {
-                _setByte(wIndex, (byte) 0);
-                wIndex++;
+            for (int i = 0; i < nBytes - 4; i++) {
+                _setByte(wIndex + i, (byte) 0);
             }
+            wIndex += nBytes - 4;
         }
         writerIndex = wIndex;
         return this;
diff --git a/buffer/src/main/java/io/netty/buffer/AbstractReferenceCountedByteBuf.java b/buffer/src/main/java/io/netty/buffer/AbstractReferenceCountedByteBuf.java
index d624d855f4..c921ae6717 100644
--- a/buffer/src/main/java/io/netty/buffer/AbstractReferenceCountedByteBuf.java
+++ b/buffer/src/main/java/io/netty/buffer/AbstractReferenceCountedByteBuf.java
@@ -60,12 +60,13 @@ public abstract class AbstractReferenceCountedByteBuf extends AbstractByteBuf {
     }
 
     private ByteBuf retain0(final int increment) {
-        int oldRef = refCntUpdater.getAndAdd(this, increment);
-        if (oldRef <= 0 || oldRef + increment < oldRef) {
-            // Ensure we don't resurrect (which means the refCnt was 0) and also that we encountered an overflow.
-            refCntUpdater.getAndAdd(this, -increment);
-            throw new IllegalReferenceCountException(oldRef, increment);
-        }
+        int oldRef;
+        do {
+            oldRef = refCntUpdater.get(this);
+            if (oldRef <= 0 || oldRef > Integer.MAX_VALUE - increment) {
+                throw new IllegalReferenceCountException(oldRef, increment);
+            }
+        } while (!refCntUpdater.compareAndSet(this, oldRef, oldRef + increment));
         return this;
     }
 
@@ -90,15 +91,21 @@ public abstract class AbstractReferenceCountedByteBuf extends AbstractByteBuf {
     }
 
     private boolean release0(int decrement) {
-        int oldRef = refCntUpdater.getAndAdd(this, -decrement);
-        if (oldRef == decrement) {
-            deallocate();
-            return true;
-        } else if (oldRef < decrement || oldRef - decrement > oldRef) {
-            // Ensure we don't over-release, and avoid underflow.
-            refCntUpdater.getAndAdd(this, decrement);
-            throw new IllegalReferenceCountException(oldRef, -decrement);
-        }
+        int oldRef;
+        do {
+            oldRef = refCntUpdater.get(this);
+            if (oldRef < decrement) {
+                throw new IllegalReferenceCountException(oldRef, -decrement);
+            }
+            if (oldRef == decrement) {
+                if (refCntUpdater.compareAndSet(this, oldRef, 0)) {
+                    deallocate();
+                    return true;
+                }
+                // CAS failed, retry
+                continue;
+            }
+        } while (!refCntUpdater.compareAndSet(this, oldRef, oldRef - decrement));
         return false;
     }
     /**
