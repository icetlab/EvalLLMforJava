diff --git a/codec-http/src/main/java/io/netty/handler/codec/http/HttpRequestEncoder.java b/codec-http/src/main/java/io/netty/handler/codec/http/HttpRequestEncoder.java
index 0db8a4ce34..3774337cca 100644
--- a/codec-http/src/main/java/io/netty/handler/codec/http/HttpRequestEncoder.java
+++ b/codec-http/src/main/java/io/netty/handler/codec/http/HttpRequestEncoder.java
@@ -51,18 +51,20 @@ public class HttpRequestEncoder extends HttpObjectEncoder<HttpRequest> {
                 int startIndex = start + 3;
                 // Correctly handle query params.
                 // See https://github.com/netty/netty/issues/2732
-                int index = uri.indexOf(QUESTION_MARK, startIndex);
-                if (index == -1) {
-                    if (uri.lastIndexOf(SLASH) <= startIndex) {
+                int queryIndex = uri.indexOf(QUESTION_MARK, startIndex);
+                int lastSlashBeforeQuery = queryIndex == -1 
+                    ? uri.lastIndexOf(SLASH) 
+                    : uri.lastIndexOf(SLASH, queryIndex);
+                
+                if (lastSlashBeforeQuery <= startIndex) {
+                    if (queryIndex == -1) {
                         uri += SLASH;
-                    }
-                } else {
-                    if (uri.lastIndexOf(SLASH, index) <= startIndex) {
-                        int len = uri.length();
-                        StringBuilder sb = new StringBuilder(len + 1);
-                        sb.append(uri, 0, index)
+                    } else {
+                        // Only allocate StringBuilder when we actually need to insert
+                        StringBuilder sb = new StringBuilder(uri.length() + 1);
+                        sb.append(uri, 0, queryIndex)
                           .append(SLASH)
-                          .append(uri, index, len);
+                          .append(uri, queryIndex, uri.length());
                         uri = sb.toString();
                     }
                 }
