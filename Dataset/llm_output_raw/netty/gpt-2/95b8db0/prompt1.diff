diff --git a/codec-http/src/main/java/io/netty/handler/codec/http/QueryStringDecoder.java b/codec-http/src/main/java/io/netty/handler/codec/http/QueryStringDecoder.java
index 01b747b3f2..e030819625 100644
--- a/codec-http/src/main/java/io/netty/handler/codec/http/QueryStringDecoder.java
+++ b/codec-http/src/main/java/io/netty/handler/codec/http/QueryStringDecoder.java
@@ -197,7 +197,8 @@ public class QueryStringDecoder {
      */
     public Map<String, List<String>> parameters() {
         if (params == null) {
-            params = decodeParams(uri, pathEndIdx(), charset, maxParams, semicolonIsNormalChar);
+            String rawQuery = rawQuery();
+            params = decodeParams(rawQuery, 0, charset, maxParams, semicolonIsNormalChar);
         }
         return params;
     }
@@ -233,7 +234,7 @@ public class QueryStringDecoder {
         if (s.charAt(from) == '?') {
             from++;
         }
-        Map<String, List<String>> params = new LinkedHashMap<String, List<String>>();
+        Map<String, List<String>> params = new LinkedHashMap<String, List<String>>(Math.min(paramsLimit, 16));
         int nameStart = from;
         int valueStart = -1;
         int i;
@@ -398,13 +399,14 @@ public class QueryStringDecoder {
     }
 
     private static int findPathEndIndex(String uri) {
-        int len = uri.length();
-        for (int i = 0; i < len; i++) {
-            char c = uri.charAt(i);
-            if (c == '?' || c == '#') {
-                return i;
+        int q = uri.indexOf('?');
+        int h = uri.indexOf('#');
+        if (q == -1) {
+            return h == -1 ? uri.length() : h;
         }
+        if (h == -1) {
+            return q;
         }
-        return len;
+        return Math.min(q, h);
     }
 }
