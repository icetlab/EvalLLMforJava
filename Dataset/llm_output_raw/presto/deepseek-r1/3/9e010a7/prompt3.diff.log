The main performance issue in `MapToMapCast.java` is that the `mapCast` method processes keys twice: once to build a key block for duplicate checking, and once for the actual map construction. This double processing is inefficient. We can optimize by:

1. Combining the duplicate checking and map construction into a single pass
2. Using the `TypedSet` more efficiently to detect duplicates during key processing
3. Eliminating the intermediate key block entirely

Here are the atomic changes to improve performance:

```json
[
  {
    "filepath": "../presto/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java",
    "search": "    @UsedByGeneratedCode\n    public static Block mapCast(\n            MethodHandle keyProcessFunction,\n            MethodHandle valueProcessFunction,\n            Type toMapType,\n            SqlFunctionProperties properties,\n            Block fromMap)\n    {\n        checkState(toMapType.getTypeParameters().size() == 2, \"Expect two type parameters for toMapType\");\n        Type toKeyType = toMapType.getTypeParameters().get(0);\n        TypedSet typedSet = new TypedSet(toKeyType, fromMap.getPositionCount() / 2, \"map-to-map cast\");\n        BlockBuilder keyBlockBuilder = toKeyType.createBlockBuilder(null, fromMap.getPositionCount() / 2);\n        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {\n            try {\n                keyProcessFunction.invokeExact(fromMap, i, properties, keyBlockBuilder);\n            }\n            catch (Throwable t) {\n                throw internalError(t);\n            }\n        }\n        Block keyBlock = keyBlockBuilder.build();\n\n        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);\n        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();\n        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {\n            if (typedSet.add(keyBlock, i / 2)) {\n                toKeyType.appendTo(keyBlock, i / 2, blockBuilder);\n                if (fromMap.isNull(i + 1)) {\n                    blockBuilder.appendNull();\n                    continue;\n                }\n\n                try {\n                    valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);\n                }\n                catch (Throwable t) {\n                    throw internalError(t);\n                }\n            }\n            else {\n                // if there are duplicated keys, fail it!\n                throw new PrestoException(INVALID_CAST_ARGUMENT, \"duplicate keys\");\n            }\n        }\n\n        mapBlockBuilder.closeEntry();\n        return (Block) toMapType.getObject(mapBlockBuilder, mapBlockBuilder.getPositionCount() - 1);\n    }",
    "replace": "    @UsedByGeneratedCode\n    public static Block mapCast(\n            MethodHandle keyProcessFunction,\n            MethodHandle valueProcessFunction,\n            Type toMapType,\n            SqlFunctionProperties properties,\n            Block fromMap)\n    {\n        checkState(toMapType.getTypeParameters().size() == 2, \"Expect two type parameters for toMapType\");\n        Type toKeyType = toMapType.getTypeParameters().get(0);\n        TypedSet typedSet = new TypedSet(toKeyType, fromMap.getPositionCount() / 2, \"map-to-map cast\");\n        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);\n        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();\n        \n        // Temporary block builder for checking duplicates without storing all keys\n        BlockBuilder tempKeyBuilder = toKeyType.createBlockBuilder(null, 1);\n        \n        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {\n            // Build the current key to temp block\n            tempKeyBuilder = toKeyType.createBlockBuilder(null, 1);\n            try {\n                keyProcessFunction.invokeExact(fromMap, i, properties, tempKeyBuilder);\n            }\n            catch (Throwable t) {\n                throw internalError(t);\n            }\n            Block tempKeyBlock = tempKeyBuilder.build();\n            \n            // Check for duplicate using the temp key block\n            if (!typedSet.add(tempKeyBlock, 0)) {\n                // if there are duplicated keys, fail it!\n                throw new PrestoException(INVALID_CAST_ARGUMENT, \"duplicate keys\");\n            }\n            \n            // Write the key to output\n            toKeyType.appendTo(tempKeyBlock, 0, blockBuilder);\n            \n            // Write the value\n            if (fromMap.isNull(i + 1)) {\n                blockBuilder.appendNull();\n                continue;\n            }\n\n            try {\n                valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);\n            }\n            catch (Throwable t) {\n                throw internalError(t);\n            }\n        }\n\n        mapBlockBuilder.closeEntry();\n        return (Block) toMapType.getObject(mapBlockBuilder, mapBlockBuilder.getPositionCount() - 1);\n    }"
  }
]
```