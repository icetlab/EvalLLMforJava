Looking at the test failures, I can see that all tests are failing with `ArrayIndexOutOfBoundsException: 230` at line 274 in `TDigest.merge()`. This suggests my previous optimizations introduced a bug where array indices are going out of bounds. The issue appears to be in my modified `merge()` method where I was trying to optimize array copying and sorting logic.

The problem is that when `activeCentroids > 0`, I was accessing arrays with incorrect indices. Let me revert to the original working `merge()` method and instead focus on simpler, safer optimizations that don't break the core algorithm. I'll keep the original `merge()` method as is and only fix the critical issue in the `add()` method's buffer management.

```json
[
  {
    "filepath": "../presto/presto-main/src/main/java/com/facebook/presto/tdigest/TDigest.java",
    "search": "    public void add(double x, long w)\n    {\n        checkArgument(!Double.isNaN(x), \"Cannot add NaN to t-digest\");\n        checkArgument(w > 0L, \"weight must be > 0\");\n\n        if (tempUsed >= tempWeight.length - activeCentroids - 1) {\n            mergeNewValues();\n        }\n        int where = tempUsed++;\n        tempWeight[where] = w;\n        tempMean[where] = x;\n        unmergedWeight += w;\n        if (x < min) {\n            min = x;\n        }\n        if (x > max) {\n            max = x;\n        }\n    }",
    "replace": "    public void add(double x, long w)\n    {\n        checkArgument(!Double.isNaN(x), \"Cannot add NaN to t-digest\");\n        checkArgument(w > 0L, \"weight must be > 0\");\n\n        // Ensure there's enough space in temp arrays for the merge operation\n        if (tempUsed >= tempWeight.length - activeCentroids) {\n            mergeNewValues();\n        }\n        int where = tempUsed++;\n        tempWeight[where] = w;\n        tempMean[where] = x;\n        unmergedWeight += w;\n        if (x < min) {\n            min = x;\n        }\n        if (x > max) {\n            max = x;\n        }\n    }"
  }
]
```