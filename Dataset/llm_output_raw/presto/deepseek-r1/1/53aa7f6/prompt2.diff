diff --git a/presto-main/src/main/java/com/facebook/presto/operator/project/GeneratedPageProjection.java b/presto-main/src/main/java/com/facebook/presto/operator/project/GeneratedPageProjection.java
index bc8850802d..eb84ccf582 100644
--- a/presto-main/src/main/java/com/facebook/presto/operator/project/GeneratedPageProjection.java
+++ b/presto-main/src/main/java/com/facebook/presto/operator/project/GeneratedPageProjection.java
@@ -38,6 +38,7 @@ public class GeneratedPageProjection
     private final MethodHandle pageProjectionWorkFactory;
 
     private List<BlockBuilder> blockBuilders;
+    private final List<com.facebook.presto.common.type.Type> projectionTypes;
 
     public GeneratedPageProjection(List<RowExpression> projections, boolean isDeterministic, InputChannels inputChannels, MethodHandle pageProjectionWorkFactory)
     {
@@ -45,7 +46,8 @@ public class GeneratedPageProjection
         this.isDeterministic = isDeterministic;
         this.inputChannels = requireNonNull(inputChannels, "inputChannels is null");
         this.pageProjectionWorkFactory = requireNonNull(pageProjectionWorkFactory, "pageProjectionWorkFactory is null");
-        this.blockBuilders = projections.stream().map(RowExpression::getType).map(type -> type.createBlockBuilder(null, 1)).collect(toImmutableList());
+        this.projectionTypes = projections.stream().map(RowExpression::getType).collect(toImmutableList());
+        this.blockBuilders = projectionTypes.stream().map(type -> type.createBlockBuilder(null, 1)).collect(toImmutableList());
     }
 
     @Override
@@ -63,7 +65,16 @@ public class GeneratedPageProjection
     @Override
     public Work<List<Block>> project(SqlFunctionProperties properties, DriverYieldSignal yieldSignal, Page page, SelectedPositions selectedPositions)
     {
-        blockBuilders = blockBuilders.stream().map(blockBuilder -> blockBuilder.newBlockBuilderLike(null)).collect(toImmutableList());
+        int positionsCount = selectedPositions.size();
+        if (positionsCount > 0) {
+            blockBuilders = projectionTypes.stream()
+                    .map(type -> type.createBlockBuilder(null, positionsCount))
+                    .collect(toImmutableList());
+        } else {
+            blockBuilders = blockBuilders.stream()
+                    .map(blockBuilder -> blockBuilder.newBlockBuilderLike(null))
+                    .collect(toImmutableList());
+        }
         try {
             return (Work<List<Block>>) pageProjectionWorkFactory.invoke(blockBuilders, properties, page, selectedPositions);
         }
