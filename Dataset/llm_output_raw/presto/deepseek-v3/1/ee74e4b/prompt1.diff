diff --git a/presto-main/src/main/java/com/facebook/presto/operator/project/PageProcessor.java b/presto-main/src/main/java/com/facebook/presto/operator/project/PageProcessor.java
index 979fc2cb80..d1d7ca1df0 100644
--- a/presto-main/src/main/java/com/facebook/presto/operator/project/PageProcessor.java
+++ b/presto-main/src/main/java/com/facebook/presto/operator/project/PageProcessor.java
@@ -77,11 +77,34 @@ public class PageProcessor
     @VisibleForTesting
     public PageProcessor(Optional<PageFilter> filter, List<PageProjectionWithOutputs> projections, OptionalInt initialBatchSize, ExpressionProfiler expressionProfiler)
     {
-        List<Integer> outputChannels = projections.stream().map(PageProjectionWithOutputs::getOutputChannels).map(Arrays::stream).map(IntStream::boxed).flatMap(identity()).distinct().collect(toImmutableList());
-        int outputCount = projections.stream().map(PageProjectionWithOutputs::getOutputCount).reduce(Integer::sum).orElse(0);
+        int outputCount = 0;
+        for (PageProjectionWithOutputs projection : projections) {
+            outputCount += projection.getOutputCount();
+        }
+        
+        // Build and validate output channels
+        int[] outputChannelsArray = new int[outputCount];
+        int index = 0;
+        for (PageProjectionWithOutputs projection : projections) {
+            int[] channels = projection.getOutputChannels();
+            System.arraycopy(channels, 0, outputChannelsArray, index, channels.length);
+            index += channels.length;
+        }
+        
+        // Sort and deduplicate for validation
+        int[] sortedChannels = outputChannelsArray.clone();
+        Arrays.sort(sortedChannels);
+        int uniqueCount = 0;
+        int last = -1;
+        for (int i = 0; i < sortedChannels.length; i++) {
+            if (sortedChannels[i] != last) {
+                uniqueCount++;
+                last = sortedChannels[i];
+            }
+        }
         verify(
-                outputChannels.size() == outputCount && (outputCount == 0 || outputChannels.stream().max(Integer::compareTo).orElse(0) == outputChannels.size() - 1),
-                format("Invalid outputChannels: outputCount: %d, outputChannels: %s", outputCount, outputChannels));
+                uniqueCount == outputCount && (outputCount == 0 || sortedChannels[outputCount - 1] == outputCount - 1),
+                format("Invalid outputChannels: outputCount: %d, outputChannels: %s", outputCount, Arrays.toString(outputChannelsArray)));
 
         this.filter = requireNonNull(filter, "filter is null")
                 .map(pageFilter -> {
@@ -216,12 +239,14 @@ public class PageProcessor
 
                 // if we produced a large page or if the expression is expensive, halve the batch size for the next call
                 long pageSize = resultPage.getSizeInBytes();
-                if (resultPage.getPositionCount() > 1 && (pageSize > MAX_PAGE_SIZE_IN_BYTES || expressionProfiler.isExpressionExpensive())) {
+                int positionCount = resultPage.getPositionCount();
+                boolean isExpensive = expressionProfiler.isExpressionExpensive();
+                if (positionCount > 1 && (pageSize > MAX_PAGE_SIZE_IN_BYTES || isExpensive)) {
                     projectBatchSize = projectBatchSize / 2;
                 }
 
                 // if we produced a small page, double the batch size for the next call
-                if (pageSize < MIN_PAGE_SIZE_IN_BYTES && projectBatchSize < MAX_BATCH_SIZE && !expressionProfiler.isExpressionExpensive()) {
+                if (pageSize < MIN_PAGE_SIZE_IN_BYTES && projectBatchSize < MAX_BATCH_SIZE && !isExpensive) {
                     projectBatchSize = projectBatchSize * 2;
                 }
 
@@ -286,29 +311,33 @@ public class PageProcessor
 
             int pageSize = 0;
             SelectedPositions positionsBatch = selectedPositions.subRange(0, batchSize);
+            int positionsBatchSize = positionsBatch.size();
+            
             for (PageProjectionWithOutputs projection : projections) {
                 if (yieldSignal.isSet()) {
                     return ProcessBatchResult.processBatchYield();
                 }
 
-                if (positionsBatch.size() > 1 && pageSize > MAX_PAGE_SIZE_IN_BYTES) {
+                if (positionsBatchSize > 1 && pageSize > MAX_PAGE_SIZE_IN_BYTES) {
                     return ProcessBatchResult.processBatchTooLarge();
                 }
 
                 // if possible, use previouslyComputedResults produced in prior optimistic failure attempt
                 int[] outputChannels = projection.getOutputChannels();
+                int firstChannel = outputChannels[0];
                 // The progress on all output channels of a projection should be the same, so we just use the first one.
-                if (previouslyComputedResults[outputChannels[0]] != null && previouslyComputedResults[outputChannels[0]].getPositionCount() >= batchSize) {
+                if (previouslyComputedResults[firstChannel] != null && previouslyComputedResults[firstChannel].getPositionCount() >= batchSize) {
                     for (int channel : outputChannels) {
-                        blocks[channel] = previouslyComputedResults[channel].getRegion(0, batchSize);
-                        pageSize += blocks[channel].getSizeInBytes();
+                        Block block = previouslyComputedResults[channel].getRegion(0, batchSize);
+                        blocks[channel] = block;
+                        pageSize += block.getSizeInBytes();
                     }
                 }
                 else {
                     if (pageProjectWork == null) {
                         expressionProfiler.start();
                         pageProjectWork = projection.project(properties, yieldSignal, projection.getPageProjection().getInputChannels().getInputChannels(page), positionsBatch);
-                        expressionProfiler.stop(positionsBatch.size());
+                        expressionProfiler.stop(positionsBatchSize);
                     }
                     if (!pageProjectWork.process()) {
                         return ProcessBatchResult.processBatchYield();
@@ -316,14 +345,15 @@ public class PageProcessor
                     List<Block> projectionOutputs = pageProjectWork.getResult();
                     for (int j = 0; j < outputChannels.length; j++) {
                         int channel = outputChannels[j];
-                        previouslyComputedResults[channel] = projectionOutputs.get(j);
-                        blocks[channel] = previouslyComputedResults[channel];
-                        pageSize += blocks[channel].getSizeInBytes();
+                        Block block = projectionOutputs.get(j);
+                        previouslyComputedResults[channel] = block;
+                        blocks[channel] = block;
+                        pageSize += block.getSizeInBytes();
                     }
                     pageProjectWork = null;
                 }
             }
-            return ProcessBatchResult.processBatchSuccess(new Page(positionsBatch.size(), blocks));
+            return ProcessBatchResult.processBatchSuccess(new Page(positionsBatchSize, blocks));
         }
     }
 
