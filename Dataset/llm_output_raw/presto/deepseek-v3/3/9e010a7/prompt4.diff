diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
index c586b38f12..dd1454fed5 100644
--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapToMapCast.java
@@ -215,37 +215,47 @@ public final class MapToMapCast
     {
         checkState(toMapType.getTypeParameters().size() == 2, "Expect two type parameters for toMapType");
         Type toKeyType = toMapType.getTypeParameters().get(0);
-        TypedSet typedSet = new TypedSet(toKeyType, fromMap.getPositionCount() / 2, "map-to-map cast");
-        BlockBuilder keyBlockBuilder = toKeyType.createBlockBuilder(null, fromMap.getPositionCount() / 2);
+        int entryCount = fromMap.getPositionCount() / 2;
+        
+        // Optimize for the common case where keys are likely unique
+        // Process keys and check for duplicates in a single pass when possible
+        TypedSet typedSet = new TypedSet(toKeyType, entryCount, "map-to-map cast");
+        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);
+        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();
+        
+        // Temporary block builder for keys to check duplicates
+        BlockBuilder tempKeyBlockBuilder = toKeyType.createBlockBuilder(null, entryCount);
+        
         for (int i = 0; i < fromMap.getPositionCount(); i += 2) {
+            // Process key into temporary block
             try {
-                keyProcessFunction.invokeExact(fromMap, i, properties, keyBlockBuilder);
+                keyProcessFunction.invokeExact(fromMap, i, properties, tempKeyBlockBuilder);
             }
             catch (Throwable t) {
                 throw internalError(t);
             }
-        }
-        Block keyBlock = keyBlockBuilder.build();
-
-        BlockBuilder mapBlockBuilder = toMapType.createBlockBuilder(null, 1);
-        BlockBuilder blockBuilder = mapBlockBuilder.beginBlockEntry();
-        for (int i = 0; i < fromMap.getPositionCount(); i += 2) {
-            if (typedSet.add(keyBlock, i / 2)) {
-                toKeyType.appendTo(keyBlock, i / 2, blockBuilder);
+            
+            // Check for duplicate using the last position in tempKeyBlockBuilder
+            int keyPosition = tempKeyBlockBuilder.getPositionCount() - 1;
+            if (typedSet.add(tempKeyBlockBuilder, keyPosition)) {
+                // Key is unique, append it to the final block
+                toKeyType.appendTo(tempKeyBlockBuilder, keyPosition, blockBuilder);
+                
+                // Process value
                 if (fromMap.isNull(i + 1)) {
                     blockBuilder.appendNull();
-                    continue;
-                }
-
-                try {
-                    valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);
                 }
-                catch (Throwable t) {
-                    throw internalError(t);
+                else {
+                    try {
+                        valueProcessFunction.invokeExact(fromMap, i + 1, properties, blockBuilder);
+                    }
+                    catch (Throwable t) {
+                        throw internalError(t);
+                    }
                 }
             }
             else {
-                // if there are duplicated keys, fail it!
+                // Duplicate key found
                 throw new PrestoException(INVALID_CAST_ARGUMENT, "duplicate keys");
             }
         }
