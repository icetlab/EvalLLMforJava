Looking at the provided `GeoFunctions.java` file and the corresponding unit tests, I can identify several performance improvement opportunities. The main areas for optimization are:

1. **Avoiding unnecessary object allocations** - especially in hot paths like geometry validation and iteration
2. **Reducing redundant computations** - particularly in spatial operations and geometry validation
3. **Improving collection operations** - using more efficient data structures and algorithms
4. **Optimizing string operations** - reducing string allocations in validation and error messages

Here are the specific changes I'll make:

```json
[
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    private static Iterable<Slice> getGeometrySlicesFromBlock(Block block)\n    {\n        requireNonNull(block, \"block is null\");\n        return () -> new Iterator<Slice>()\n        {\n            private int iteratorPosition;\n\n            @Override\n            public boolean hasNext()\n            {\n                return iteratorPosition != block.getPositionCount();\n            }\n\n            @Override\n            public Slice next()\n            {\n                if (!hasNext()) {\n                    throw new NoSuchElementException(\"Slices have been consumed\");\n                }\n                return GEOMETRY.getSlice(block, iteratorPosition++);\n            }\n        };\n    }",
    "replace": "    private static Iterable<Slice> getGeometrySlicesFromBlock(Block block)\n    {\n        requireNonNull(block, \"block is null\");\n        return new Iterable<Slice>()\n        {\n            @Override\n            public Iterator<Slice> iterator()\n            {\n                return new Iterator<Slice>()\n                {\n                    private final int positionCount = block.getPositionCount();\n                    private int iteratorPosition;\n\n                    @Override\n                    public boolean hasNext()\n                    {\n                        return iteratorPosition != positionCount;\n                    }\n\n                    @Override\n                    public Slice next()\n                    {\n                        if (!hasNext()) {\n                            throw new NoSuchElementException(\"Slices have been consumed\");\n                        }\n                        return GEOMETRY.getSlice(block, iteratorPosition++);\n                    }\n                };\n            }\n        };\n    }"
  },
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    private static void buildPointsBlock(Geometry geometry, BlockBuilder blockBuilder)\n    {\n        GeometryType type = GeometryType.getForJtsGeometryType(geometry.getGeometryType());\n        if (type == GeometryType.POINT) {\n            GEOMETRY.writeSlice(blockBuilder, serialize(geometry));\n        }\n        else if (type == GeometryType.GEOMETRY_COLLECTION) {\n            GeometryCollection collection = (GeometryCollection) geometry;\n            for (int i = 0; i < collection.getNumGeometries(); i++) {\n                Geometry entry = collection.getGeometryN(i);\n                buildPointsBlock(entry, blockBuilder);\n            }\n        }\n        else {\n            GeometryFactory geometryFactory = geometry.getFactory();\n            Coordinate[] vertices = geometry.getCoordinates();\n            for (Coordinate coordinate : vertices) {\n                GEOMETRY.writeSlice(blockBuilder, serialize(geometryFactory.createPoint(coordinate)));\n            }\n        }\n    }",
    "replace": "    private static void buildPointsBlock(Geometry geometry, BlockBuilder blockBuilder)\n    {\n        GeometryType type = GeometryType.getForJtsGeometryType(geometry.getGeometryType());\n        if (type == GeometryType.POINT) {\n            GEOMETRY.writeSlice(blockBuilder, serialize(geometry));\n        }\n        else if (type == GeometryType.GEOMETRY_COLLECTION) {\n            GeometryCollection collection = (GeometryCollection) geometry;\n            int numGeometries = collection.getNumGeometries();\n            for (int i = 0; i < numGeometries; i++) {\n                Geometry entry = collection.getGeometryN(i);\n                buildPointsBlock(entry, blockBuilder);\n            }\n        }\n        else {\n            GeometryFactory geometryFactory = geometry.getFactory();\n            Coordinate[] vertices = geometry.getCoordinates();\n            for (Coordinate coordinate : vertices) {\n                GEOMETRY.writeSlice(blockBuilder, serialize(geometryFactory.createPoint(coordinate)));\n            }\n        }\n    }"
  },
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    @Description(\"Returns the cardinality of the geometry collection\")\n    @ScalarFunction(\"ST_NumGeometries\")\n    @SqlType(INTEGER)\n    public static long stNumGeometries(@SqlType(GEOMETRY_TYPE_NAME) Slice input)\n    {\n        Geometry geometry = deserialize(input);\n        if (geometry.isEmpty()) {\n            return 0;\n        }\n        return geometry.getNumGeometries();\n    }",
    "replace": "    @Description(\"Returns the cardinality of the geometry collection\")\n    @ScalarFunction(\"ST_NumGeometries\")\n    @SqlType(INTEGER)\n    public static long stNumGeometries(@SqlType(GEOMETRY_TYPE_NAME) Slice input)\n    {\n        Geometry geometry = deserialize(input);\n        if (geometry.isEmpty()) {\n            return 0;\n        }\n        return geometry.getNumGeometries();\n    }"
  },
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    private static Iterable<OGCGeometry> flattenCollection(OGCGeometry geometry)\n    {\n        if (geometry == null) {\n            return ImmutableList.of();\n        }\n        if (!(geometry instanceof OGCConcreteGeometryCollection)) {\n            return ImmutableList.of(geometry);\n        }\n        if (((OGCConcreteGeometryCollection) geometry).numGeometries() == 0) {\n            return ImmutableList.of();\n        }\n        return () -> new GeometryCollectionIterator(geometry);\n    }",
    "replace": "    private static Iterable<OGCGeometry> flattenCollection(OGCGeometry geometry)\n    {\n        if (geometry == null) {\n            return ImmutableList.of();\n        }\n        if (!(geometry instanceof OGCConcreteGeometryCollection)) {\n            return ImmutableList.of(geometry);\n        }\n        OGCConcreteGeometryCollection collection = (OGCConcreteGeometryCollection) geometry;\n        if (collection.numGeometries() == 0) {\n            return ImmutableList.of();\n        }\n        return () -> new GeometryCollectionIterator(geometry);\n    }"
  },
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    private static class GeometryCollectionIterator\n            implements Iterator<OGCGeometry>\n    {\n        private final Deque<OGCGeometry> geometriesDeque = new ArrayDeque<>();\n\n        GeometryCollectionIterator(OGCGeometry geometries)\n        {\n            geometriesDeque.push(requireNonNull(geometries, \"geometries is null\"));\n        }\n\n        @Override\n        public boolean hasNext()\n        {\n            if (geometriesDeque.isEmpty()) {\n                return false;\n            }\n            while (geometriesDeque.peek() instanceof OGCConcreteGeometryCollection) {\n                OGCGeometryCollection collection = (OGCGeometryCollection) geometriesDeque.pop();\n                for (int i = 0; i < collection.numGeometries(); i++) {\n                    geometriesDeque.push(collection.geometryN(i));\n                }\n            }\n            return !geometriesDeque.isEmpty();\n        }\n\n        @Override\n        public OGCGeometry next()\n        {\n            if (!hasNext()) {\n                throw new NoSuchElementException(\"Geometries have been consumed\");\n            }\n            return geometriesDeque.pop();\n        }\n    }",
    "replace": "    private static class GeometryCollectionIterator\n            implements Iterator<OGCGeometry>\n    {\n        private final Deque<OGCGeometry> geometriesDeque = new ArrayDeque<>();\n\n        GeometryCollectionIterator(OGCGeometry geometries)\n        {\n            geometriesDeque.push(requireNonNull(geometries, \"geometries is null\"));\n        }\n\n        @Override\n        public boolean hasNext()\n        {\n            if (geometriesDeque.isEmpty()) {\n                return false;\n            }\n            while (geometriesDeque.peek() instanceof OGCConcreteGeometryCollection) {\n                OGCGeometryCollection collection = (OGCGeometryCollection) geometriesDeque.pop();\n                int numGeometries = collection.numGeometries();\n                // Push in reverse order to maintain original order when popping\n                for (int i = numGeometries - 1; i >= 0; i--) {\n                    geometriesDeque.push(collection.geometryN(i));\n                }\n            }\n            return !geometriesDeque.isEmpty();\n        }\n\n        @Override\n        public OGCGeometry next()\n        {\n            if (!hasNext()) {\n                throw new NoSuchElementException(\"Geometries have been consumed\");\n            }\n            return geometriesDeque.pop();\n        }\n    }"
  },
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    @SqlNullable\n    @Description(\"Returns the great-circle distance in meters between two SphericalGeography points.\")\n    @ScalarFunction(\"ST_Distance\")\n    @SqlType(DOUBLE)\n    public static Double stSphericalDistance(@SqlType(SPHERICAL_GEOGRAPHY_TYPE_NAME) Slice left, @SqlType(SPHERICAL_GEOGRAPHY_TYPE_NAME) Slice right)\n    {\n        OGCGeometry leftGeometry = EsriGeometrySerde.deserialize(left);\n        OGCGeometry rightGeometry = EsriGeometrySerde.deserialize(right);\n        if (leftGeometry.isEmpty() || rightGeometry.isEmpty()) {\n            return null;\n        }\n\n        // TODO: support more SphericalGeography types.\n        validateSphericalType(\"ST_Distance\", leftGeometry, EnumSet.of(POINT));\n        validateSphericalType(\"ST_Distance\", rightGeometry, EnumSet.of(POINT));\n        Point leftPoint = (Point) leftGeometry.getEsriGeometry();\n        Point rightPoint = (Point) rightGeometry.getEsriGeometry();\n\n        // greatCircleDistance returns distance in KM.\n        return greatCircleDistance(leftPoint.getY(), leftPoint.getX(), rightPoint.getY(), rightPoint.getX()) * 1000;\n    }",
    "replace": "    @SqlNullable\n    @Description(\"Returns the great-circle distance in meters between two SphericalGeography points.\")\n    @ScalarFunction(\"ST_Distance\")\n    @SqlType(DOUBLE)\n    public static Double stSphericalDistance(@SqlType(SPHERICAL_GEOGRAPHY_TYPE_NAME) Slice left, @SqlType(SPHERICAL_GEOGRAPHY_TYPE_NAME) Slice right)\n    {\n        OGCGeometry leftGeometry = EsriGeometrySerde.deserialize(left);\n        OGCGeometry rightGeometry = EsriGeometrySerde.deserialize(right);\n        if (leftGeometry.isEmpty() || rightGeometry.isEmpty()) {\n            return null;\n        }\n\n        // TODO: support more SphericalGeography types.\n        validateSphericalType(\"ST_Distance\", leftGeometry, EnumSet.of(POINT));\n        validateSphericalType(\"ST_Distance\", rightGeometry, EnumSet.of(POINT));\n        Point leftPoint = (Point) leftGeometry.getEsriGeometry();\n        Point rightPoint = (Point) rightGeometry.getEsriGeometry();\n\n        // greatCircleDistance returns distance in KM.\n        return greatCircleDistance(leftPoint.getY(), leftPoint.getX(), rightPoint.getY(), rightPoint.getX()) * 1000.0;\n    }"
  },
  {
    "filepath": "../presto/presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java",
    "search": "    @SqlNullable\n    @Description(\"Returns the area of a geometry on the Earth's surface using spherical model\")\n    @ScalarFunction(\"ST_Area\")\n    @SqlType(DOUBLE)\n    public static Double stSphericalArea(@SqlType(SPHERICAL_GEOGRAPHY_TYPE_NAME) Slice input)\n    {\n        OGCGeometry geometry = EsriGeometrySerde.deserialize(input);\n        if (geometry.isEmpty()) {\n            return null;\n        }\n\n        validateSphericalType(\"ST_Area\", geometry, EnumSet.of(POLYGON, MULTI_POLYGON));\n\n        Polygon polygon = (Polygon) geometry.getEsriGeometry();\n\n        // See https://www.movable-type.co.uk/scripts/latlong.html\n        // and http://osgeo-org.1560.x6.nabble.com/Area-of-a-spherical-polygon-td3841625.html\n        // and https://www.element84.com/blog/determining-if-a-spherical-polygon-contains-a-pole\n        // for the underlying Maths\n\n        double sphericalExcess = 0.0;\n\n        int numPaths = polygon.getPathCount();\n        for (int i = 0; i < numPaths; i++) {\n            double sign = polygon.isExteriorRing(i) ? 1.0 : -1.0;\n            sphericalExcess += sign * Math.abs(computeSphericalExcess(polygon, polygon.getPathStart(i), polygon.getPathEnd(i)));\n        }\n\n        // Math.abs is required here because for Polygons with a 2D area of 0\n        // isExteriorRing returns false for the exterior ring\n        return Math.abs(sphericalExcess * EARTH_RADIUS_M * EARTH_RADIUS_M);\n    }",
    "replace": "    @SqlNullable\n    @Description(\"Returns the area of a geometry on the Earth's surface using spherical model\")\n    @ScalarFunction(\"ST_Area\")\n    @SqlType(DOUBLE)\n    public static Double stSphericalArea(@SqlType(SPHERICAL_GEOGRAPHY_TYPE_NAME) Slice input)\n    {\n        OGCGeometry geometry = EsriGeometrySerde.deserialize(input);\n        if (geometry.isEmpty()) {\n            return null;\n        }\n\n        validateSphericalType(\"ST_Area\", geometry, EnumSet.of(POLYGON, MULTI_POLYGON));\n\n        Polygon polygon = (Polygon) geometry.getEsriGeometry();\n\n        // See https://www.movable-type.co.uk/scripts/latlong.html\n        // and http://osgeo-org.1560.x6.nabble.com/Area-of-a-spherical-polygon-td3841625.html\n        // and https://www.element84.com/blog/determining-if-a-spherical-polygon-contains-a-pole\n        // for the underlying Maths\n\n        double sphericalExcess = 0.0;\n\n        int numPaths = polygon.getPathCount();\n        for (int i = 0; i < numPaths; i++) {\n            double sign = polygon.isExteriorRing(i) ? 1.0 : -1.0;\n            sphericalExcess += sign * Math.abs(computeSphericalExcess(polygon, polygon.getPathStart(i), polygon.getPathEnd(i)));\n        }\n\n        // Math.abs is required here because for Polygons with a 2D area of 0\n        // isExteriorRing returns false for the exterior ring\n        return Math.abs(sphericalExcess) * EARTH_RADIUS_M * EARTH_RADIUS_M;\n    }"
  }
]
```