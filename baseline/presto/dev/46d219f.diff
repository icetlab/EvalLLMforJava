commit 46d219f7912b210ab0a9ab6239e6d7e96ad56ec5
Author: Rongrong Zhong <rongrong@fb.com>
Date:   Wed Dec 7 11:29:38 2016 -0800

    Optimize map_concat to skip empty map
    
    Performance before:
    Benchmark                     (mapConfig)  Mode  Cnt     Score     Error  Units
    BenchmarkMapConcat.mapConcat   left_empty  avgt   20  1838.641 ± 145.909  ns/op
    BenchmarkMapConcat.mapConcat  right_empty  avgt   20  1515.713 ±  96.888  ns/op
    BenchmarkMapConcat.mapConcat   both_empty  avgt   20   615.368 ±  57.051  ns/op
    BenchmarkMapConcat.mapConcat    non_empty  avgt   20  2753.727 ± 503.407  ns/op
    
    Performance After:
    Benchmark                     (mapConfig)  Mode  Cnt     Score     Error  Units
    BenchmarkMapConcat.mapConcat   left_empty  avgt   20   392.266 ±  38.556  ns/op
    BenchmarkMapConcat.mapConcat  right_empty  avgt   20   376.552 ±  32.928  ns/op
    BenchmarkMapConcat.mapConcat   both_empty  avgt   20    55.276 ±   7.683  ns/op
    BenchmarkMapConcat.mapConcat    non_empty  avgt   20  3043.951 ± 553.951  ns/op

diff --git a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapConcatFunction.java b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapConcatFunction.java
index 24e83bddde..fbb9b172d2 100644
--- a/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapConcatFunction.java
+++ b/presto-main/src/main/java/com/facebook/presto/operator/scalar/MapConcatFunction.java
@@ -40,6 +40,13 @@ public final class MapConcatFunction
             @SqlType("map(K,V)") Block leftMap,
             @SqlType("map(K,V)") Block rightMap)
     {
+        if (leftMap.getPositionCount() == 0) {
+            return rightMap;
+        }
+        if (rightMap.getPositionCount() == 0) {
+            return leftMap;
+        }
+
         TypedSet typedSet = new TypedSet(keyType, rightMap.getPositionCount());
         BlockBuilder blockBuilder = new InterleavedBlockBuilder(ImmutableList.of(keyType, valueType), new BlockBuilderStatus(), leftMap.getPositionCount() + rightMap.getPositionCount());
         for (int i = 0; i < rightMap.getPositionCount(); i += 2) {
